<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lecturer Portal</title>
  <style>
    :root {
      --primary: #004080;
      --primary-600: #003366;
      --accent: #0059b3;
      --warn: #e53935;
      --yellow: #ffc107;
      --bg: #f4f7fa;
      --card: #ffffff;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Arial, sans-serif; background: var(--bg); display: flex; }

    /* Sidebar */
    .sidebar { width: 260px; background: var(--primary); color: #fff; height: 100vh; padding: 20px 14px; position: sticky; top: 0; }
    .sidebar .profile { text-align: center; margin-bottom: 20px; }
    .sidebar .profile img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 3px solid rgba(255,255,255,0.25); }
    .sidebar h3 { margin: 0; font-size: 16px; }
    .sidebar p { margin: 2px 0; font-size: 13px; opacity: .9; }
    .sidebar ul { list-style: none; padding: 0; margin: 10px 0 0; }
    .sidebar ul li { padding: 10px 12px; margin: 6px 0; background: var(--accent); border-radius: 8px; cursor: pointer; user-select: none; }
    .sidebar ul li:hover { background: var(--primary-600); }

    /* Main */
    .main { flex: 1; padding: 22px; max-width: 1200px; margin: 0 auto; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .header h2 { margin: 0; color: var(--primary); }
    .btn { background: var(--primary); color: #fff; border: none; padding: 10px 14px; border-radius: 8px; cursor: pointer; }
    .btn.warn { background: var(--warn); }
    .btn.yellow { background: var(--yellow); color: #000; }

    /* Cards / forms */
    .card { background: var(--card); padding: 18px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 18px; }
    .card h3 { margin: 0 0 12px; color: var(--primary); }
    label { display: block; margin: 10px 0 6px; font-weight: 600; }
    input, select { width: 100%; padding: 10px; border: 1px solid #d0d7de; border-radius: 8px; }
    .row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .row-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .row-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .mt-10 { margin-top: 10px; }

    table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; font-size: 14px; }
    th { background: #f5f7fb; }

    .action-btn { padding: 6px 10px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; }
    .edit-btn { background: var(--yellow); }
    .delete-btn { background: var(--warn); color: #fff; }

    /* Sections toggle */
    [data-section] { display: none; }
    [data-section].active { display: block; }

    /* Settings avatar */
    .avatar-wrap { display: flex; gap: 16px; align-items: center; }
    .avatar-wrap img { width: 96px; height: 96px; border-radius: 50%; object-fit: cover; border: 2px solid #e5e7eb; }

    @media (max-width: 900px) {
      .row, .row-3, .row-2 { grid-template-columns: 1fr; }
      .sidebar { position: fixed; left: 0; top: 0; transform: translateX(0); height: 100%; z-index: 10; }
      .main { margin-left: 0; padding: 16px; }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="profile">
      <img id="sidebarAvatar" src="https://via.placeholder.com/100" alt="Lecturer" />
      <h3 id="sidebarName">Dr. John Doe</h3>
      <p id="sidebarId">Lecturer ID: LEC123</p>
    </div>
    <ul>
      <li onclick="showSection('courses')">üìò My Courses</li>
      <li onclick="showSection('results')">üìù Add Results</li>
      <li onclick="showSection('viewResults')">üìä View Results</li>
      <li onclick="showSection('settings')">‚öôÔ∏è Settings</li>
    </ul>
  </aside>

  <!-- Main Content -->
  <main class="main">
    <div class="header">
      <h2>Lecturer Portal</h2>
      <div>
        <button class="btn yellow" onclick="seedDemo()">Seed Demo Data</button>
        <button class="btn" onclick="signOutIfFirebase()">Logout</button>
      </div>
    </div>

    <!-- COURSES -->
    <section id="courses" data-section class="card active">
      <h3>Add Course</h3>
      <div class="row">
        <div>
          <label for="courseCode">Course Code</label>
          <input id="courseCode" placeholder="e.g., COSC2101" />
        </div>
        <div>
          <label for="courseTitle">Course Title</label>
          <input id="courseTitle" placeholder="e.g., Web Development" />
        </div>
        <div>
          <label for="credits">Credit Units</label>
          <input id="credits" type="number" min="1" max="30" placeholder="3" />
        </div>
        <div>
          <label for="semester">Semester</label>
          <select id="semester">
            <option value="">-- Select --</option>
            <option>Semester 1</option>
            <option>Semester 2</option>
          </select>
        </div>
      </div>
      <button class="btn mt-10" onclick="addCourse()">Add Course</button>

      <h3 class="mt-10">My Courses</h3>
      <table id="courseTable">
        <thead>
          <tr>
            <th>Code</th><th>Title</th><th>Credits</th><th>Semester</th><th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- ADD RESULTS -->
    <section id="results" data-section class="card">
      <h3>Add Student Results</h3>
      <div class="row-3">
        <div>
          <label for="courseSelect">Select Course</label>
          <select id="courseSelect"></select>
        </div>
        <div>
          <label for="student">Student Name</label>
          <input id="student" placeholder="e.g., Atuma Gilbert" />
        </div>
        <div>
          <label for="marks">Marks</label>
          <input id="marks" type="number" min="0" max="100" placeholder="Enter marks" />
        </div>
      </div>
      <button class="btn mt-10" onclick="addResult()">Submit Result</button>
    </section>

    <!-- VIEW RESULTS -->
    <section id="viewResults" data-section class="card">
      <h3>Submitted Results</h3>
      <table id="resultsTable">
        <thead>
          <tr>
            <th>Course</th><th>Student</th><th>Marks</th><th>Grade</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- SETTINGS -->
    <section id="settings" data-section class="card">
      <h3>Settings</h3>
      <div class="avatar-wrap">
        <img id="settingsAvatar" src="https://via.placeholder.com/150" alt="Profile preview" />
        <div>
          <label for="avatarInput">Change Profile Photo</label>
          <input id="avatarInput" type="file" accept="image/*" />
          <div class="mt-10">
            <button class="btn" onclick="uploadAvatar()">Upload & Save Photo</button>
          </div>
        </div>
      </div>

      <div class="row-2 mt-10">
        <div>
          <label for="username">Username (display name)</label>
          <input id="username" placeholder="Dr. John Doe" />
        </div>
        <div>
          <label for="email">Email</label>
          <input id="email" type="email" placeholder="john@university.edu" />
        </div>
      </div>
      <div class="row-2 mt-10">
        <div>
          <label for="password">New Password</label>
          <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
        <div>
          <label for="password2">Confirm Password</label>
          <input id="password2" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
      </div>
      <button class="btn mt-10" onclick="saveSettings()">Save Account Settings</button>
    </section>
  </main>

  <!-- Firebase SDKs (Modular v9) -->
  <script type="module">
    // ======== CONFIGURE FIREBASE HERE ========
    // 1) Replace with your Firebase project config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // 2) Toggle this to true after you paste real config
    const USE_FIREBASE = false; // set to true when config is valid

    // Conditional imports so the page works even without Firebase
    let app, auth, db, storage;
    let onAuthStateChanged, signOut, updateProfile, updatePassword, updateEmail;
    let getDownloadURL, ref, uploadBytes;
    let collection, addDoc, getDocs, setDoc, doc, query, where;

    async function initFirebase() {
      if (!USE_FIREBASE) return;
      const firebaseApp = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js');
      const firebaseAuth = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js');
      const firebaseFirestore = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
      const firebaseStorage = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js');

      app = firebaseApp.initializeApp(firebaseConfig);
      auth = firebaseAuth.getAuth(app);
      db = firebaseFirestore.getFirestore(app);
      storage = firebaseStorage.getStorage(app);

      ({ onAuthStateChanged, signOut, updateProfile, updatePassword, updateEmail } = firebaseAuth);
      ({ ref, uploadBytes, getDownloadURL } = firebaseStorage);
      ({ collection, addDoc, getDocs, setDoc, doc, query, where } = firebaseFirestore);

      // Listen to auth state (optional UI wiring)
      onAuthStateChanged(auth, (user) => {
        if (user) {
          // Populate UI with user info
          document.getElementById('sidebarName').textContent = user.displayName || 'Lecturer';
          document.getElementById('email').value = user.email || '';
          if (user.photoURL) {
            document.getElementById('sidebarAvatar').src = user.photoURL;
            document.getElementById('settingsAvatar').src = user.photoURL;
          }
        }
      });
    }

    // ======== LOCAL STATE (fallback when Firebase is off) ========
    const state = {
      courses: [],
      results: []
    };

    // ======== UI HELPERS ========
    window.showSection = (id) => {
      document.querySelectorAll('[data-section]').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    };

    function refreshCourseTable() {
      const tbody = document.querySelector('#courseTable tbody');
      tbody.innerHTML = '';
      state.courses.forEach((c, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${c.code}</td><td>${c.title}</td><td>${c.credits}</td><td>${c.semester}</td>
          <td>
            <button class="action-btn edit-btn" onclick="editCourse(${i})">Edit</button>
            <button class="action-btn delete-btn" onclick="deleteCourse(${i})">Delete</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    function refreshCourseSelect() {
      const sel = document.getElementById('courseSelect');
      sel.innerHTML = '';
      state.courses.forEach(c => {
        const o = document.createElement('option');
        o.value = c.code; o.textContent = `${c.code} - ${c.title}`; sel.appendChild(o);
      });
    }

    function gradeFromMarks(m) {
      m = Number(m);
      if (m >= 80) return 'A';
      if (m >= 70) return 'B+';
      if (m >= 60) return 'B';
      if (m >= 50) return 'C';
      if (m >= 45) return 'D';
      return 'F';
    }

    function refreshResultsTable() {
      const tbody = document.querySelector('#resultsTable tbody');
      tbody.innerHTML = '';
      state.results.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.course}</td><td>${r.student}</td><td>${r.marks}</td><td>${gradeFromMarks(r.marks)}</td>`;
        tbody.appendChild(tr);
      });
    }

    // ======== COURSES ========
    window.addCourse = () => {
      const code = document.getElementById('courseCode').value.trim();
      const title = document.getElementById('courseTitle').value.trim();
      const credits = document.getElementById('credits').value.trim();
      const semester = document.getElementById('semester').value;
      if (!code || !title || !credits || !semester) return alert('Please fill all fields');
      state.courses.push({ code, title, credits, semester });
      document.getElementById('courseCode').value = '';
      document.getElementById('courseTitle').value = '';
      document.getElementById('credits').value = '';
      document.getElementById('semester').value = '';
      refreshCourseTable();
      refreshCourseSelect();
      // Optional Firestore save (when enabled)
      // if (USE_FIREBASE && auth.currentUser) await setDoc(doc(db, 'courses', code), { code, title, credits, semester, owner: auth.currentUser.uid });
    };

    window.editCourse = (i) => {
      const c = state.courses[i];
      document.getElementById('courseCode').value = c.code;
      document.getElementById('courseTitle').value = c.title;
      document.getElementById('credits').value = c.credits;
      document.getElementById('semester').value = c.semester;
      state.courses.splice(i, 1);
      refreshCourseTable();
      refreshCourseSelect();
    };

    window.deleteCourse = (i) => {
      state.courses.splice(i, 1);
      refreshCourseTable();
      refreshCourseSelect();
    };

    // ======== RESULTS ========
    window.addResult = () => {
      const course = document.getElementById('courseSelect').value;
      const student = document.getElementById('student').value.trim();
      const marks = document.getElementById('marks').value.trim();
      if (!course || !student || marks === '') return alert('Please fill all fields');
      state.results.push({ course, student, marks: Number(marks) });
      document.getElementById('student').value = '';
      document.getElementById('marks').value = '';
      refreshResultsTable();
      // Optional Firestore add: if (USE_FIREBASE) await addDoc(collection(db, 'results'), { course, student, marks: Number(marks), owner: auth.currentUser?.uid || null });
    };

    // ======== SETTINGS ========
    const avatarInput = document.getElementById('avatarInput');
    const settingsAvatar = document.getElementById('settingsAvatar');

    avatarInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => { settingsAvatar.src = reader.result; };
      reader.readAsDataURL(file); // instant preview
    });

    window.uploadAvatar = async () => {
      const file = avatarInput.files?.[0];
      if (!file) return alert('Pick a photo first');

      // Update sidebar preview immediately
      document.getElementById('sidebarAvatar').src = settingsAvatar.src;

      if (USE_FIREBASE) {
        try {
          const user = auth.currentUser;
          if (!user) throw new Error('Not signed in');
          const storagePath = `lecturers/${user.uid}/profile.jpg`;
          const storageRef = ref(storage, storagePath);
          await uploadBytes(storageRef, file);
          const url = await getDownloadURL(storageRef);
          await updateProfile(user, { photoURL: url });
          document.getElementById('sidebarAvatar').src = url;
          settingsAvatar.src = url;
          alert('Profile photo updated');
        } catch (err) {
          console.error(err); alert('Upload failed: ' + err.message);
        }
      } else {
        alert('Preview updated. Enable Firebase to persist the photo.');
      }
    };

    window.saveSettings = async () => {
      const displayName = document.getElementById('username').value.trim();
      const email = document.getElementById('email').value.trim();
      const pass = document.getElementById('password').value;
      const pass2 = document.getElementById('password2').value;

      // Update sidebar name locally
      if (displayName) document.getElementById('sidebarName').textContent = displayName;

      if (!USE_FIREBASE) {
        alert('Saved locally. Enable Firebase to persist account changes.');
        return;
      }

      try {
        const user = auth.currentUser;
        if (!user) throw new Error('Not signed in');
        if (displayName) await updateProfile(user, { displayName });
        if (email && email !== user.email) await updateEmail(user, email);
        if (pass || pass2) {
          if (pass !== pass2) throw new Error('Passwords do not match');
          if (pass.length < 6) throw new Error('Password must be at least 6 characters');
          await updatePassword(user, pass);
        }
        alert('Account settings updated');
      } catch (err) {
        console.error(err); alert('Update failed: ' + err.message);
      }
    };

    window.signOutIfFirebase = async () => {
      if (!USE_FIREBASE) { alert('Demo mode: no sign out.'); return; }
      try { await signOut(auth); alert('Signed out'); } catch (e) { alert(e.message); }
    };

    // Demo data
    window.seedDemo = () => {
      if (state.courses.length === 0) {
        state.courses.push(
          { code: 'ICT101', title: 'Computer Basics', credits: 3, semester: 'Semester 1' },
          { code: 'MAT202', title: 'Linear Algebra', credits: 4, semester: 'Semester 2' },
          { code: 'PHY301', title: 'Mechanics', credits: 3, semester: 'Semester 1' }
        );
        refreshCourseTable();
        refreshCourseSelect();
      }
      if (state.results.length === 0) {
        state.results.push(
          { course: 'ICT101', student: 'Atuma Gilbert', marks: 86 },
          { course: 'MAT202', student: 'Jane A.', marks: 73 },
          { course: 'PHY301', student: 'Brian K.', marks: 58 }
        );
        refreshResultsTable();
      }
    };

    // Init
    refreshCourseTable();
    refreshCourseSelect();
    refreshResultsTable();
    initFirebase();
  </script>
</body>
</html>
